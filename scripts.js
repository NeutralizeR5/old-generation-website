const translations = {
  en: {
    title: "OLD GENERATION OFFICIAL PORTAL",
    header_subtitle: "PRESERVING LEGACY COMMANDING DESTINY",
    nav_stats: "Intelligence", nav_profiles: "Legion", nav_terminology: "Calculator", nav_contact: "Recruitment",
    stats_title: "Guild Stats", members_label: "Active Members", might_label: "Guild Might", level_label: "Guild Level",
    profiles_title: "Guild Leadership", member1_name: "Supreme Leader", member1_role: "R5 LEADER",
    member2_name: "War General", member2_role: "R4 WAR LEADER", member3_name: "Shield Master", member3_role: "R4 DEFENCE LEADER",
    terminology_title: "Tactical Guide",
    calc_title: "Troop Calculator", calc_label_total: "March/Rally Capacity", calc_label_split: "Troop Ratio",
    calc_split_40: "40% T5 60% T4 (Standard)", calc_split_50: "50% T5 50% T4 (Balanced)", calc_split_60: "60% T5 40% T4 (Heavy)", calc_split_100: "100% T4 (Pure)",
    calc_label_comp: "Formation Strategy", comp_inf: "Infantry Blast", comp_rng: "Ranged Blast", comp_cav: "Cavalry Blast",
    comp_442: "Mixed 4 4 2 (Infantry Ranged)", comp_424: "Mixed 4 2 4 (Infantry Cavalry)", comp_244: "Mixed 2 4 4 (Ranged Cavalry)",
    btn_calculate: "Calculate Troops", calc_result_title: "Troop Deployment Overview", res_inf_title: "Infantry", res_rng_title: "Ranged", res_cav_title: "Cavalry",
    btn_copy: "Copy", msg_copied: "Copied!",
    contact_title: "Application Form", label_name: "In Game Name", label_iggid: "IGG ID", label_might: "Total Might",
    label_role: "Combat Role", opt_filler: "Rally Filler", opt_rally: "Rally Lead", label_message: "Message", form_disclaimer: "Please fill out the form completely.",
    prev_btn: "Back", next_btn: "Proceed", submit_btn: "Submit Application",
    footer1: "OLD GENERATION: Cultivating martial excellence since 2016.", copy_title: "SOVEREIGN PROTECTION", copy_message: "This property belongs to OLD GENERATION.",
    ph_name: "Enter your exact player name", ph_iggid: "Numeric Identity", ph_might: "e.g. 2.5B", ph_message: "Tell us why you want to join...",
    btn_unmute: "UNMUTE", btn_mute: "MUTE"
  },
  tr: {
    title: "OLD GENERATION ASLA PES ETME",
    header_subtitle: "MİRASI KORUYOR KADERİ YENİYORUZ",
    nav_stats: "İstihbarat", nav_profiles: "Lejyon", nav_terminology: "Hesaplayıcı", nav_contact: "Başvuru",
    stats_title: "Lonca İstatistikleri", members_label: "Aktif Üyeler", might_label: "Lonca Kudreti", level_label: "Lonca Seviyesi",
    profiles_title: "Lonca Liderliği", member1_name: "Yüce Lider", member1_role: "R5 LİDER",
    member2_name: "Savaş Generali", member2_role: "R4 SAVAŞ LİDERİ", member3_name: "Kalkan Ustası", member3_role: "R4 SAVUNMA LİDERİ",
    terminology_title: "Taktik Rehber",
    calc_title: "Asker Hesaplayıcı", calc_label_total: "Sefer/Ralli Kapasitesi", calc_label_split: "Birlik Oranı",
    calc_split_40: "40% T5 60% T4 (Standart)", calc_split_50: "50% T5 50% T4 (Dengeli)", calc_split_60: "60% T5 40% T4 (Ağır)", calc_split_100: "100% T4 (Saf)",
    calc_label_comp: "Formasyon Stratejisi", comp_inf: "Piyade Saf (Blast)", comp_rng: "Menzilli Saf (Blast)", comp_cav: "Süvari Saf (Blast)",
    comp_442: "Karma 4 4 2 (Piyade ve Menzilli)", comp_424: "Karma 4 2 4 (Piyade ve Süvari)", comp_244: "Karma 2 4 4 (Menzilli ve Süvari)",
    btn_calculate: "Birlikleri Hesapla", calc_result_title: "Ordu Dağılım Özeti", res_inf_title: "Piyade", res_rng_title: "Menzilli", res_cav_title: "Süvari",
    btn_copy: "Panoya Kopyala", msg_copied: "Kopyalandı!",
    contact_title: "Üyelik Başvurusu", label_name: "Oyun İçi İsim", label_iggid: "IGG ID", label_might: "Toplam Kudret",
    label_role: "Savaş Rolü", opt_filler: "Destek (Filler)", opt_rally: "Ralli Lideri", label_message: "Mesaj", form_disclaimer: "Lütfen formu eksiksiz doldurunuz.",
    prev_btn: "Geri", next_btn: "Devam Et", submit_btn: "Başvuruyu Gönder",
    footer1: "OLD GENERATION: 2016'dan beri askeri mükemmellik inşa ediyoruz.", copy_title: "İÇERİK KORUMASI", copy_message: "Bu mülkiyet OLD GENERATION'a aittir.",
    ph_name: "Oyun içi adınızı girin", ph_iggid: "Sayısal Kimliğiniz", ph_might: "Örn. 2.5B", ph_message: "Katılma amacınızı kısaca anlatın...",
    btn_unmute: "SESİ AÇ", btn_mute: "SESİ KAPAT"
  },
  it: {
    title: "OLD GENERATION PORTALE UFFICIALE",
    header_subtitle: "PRESERVARE L'EREDITÀ COMANDARE IL DESTINO",
    nav_stats: "Statistiche", nav_profiles: "Legione", nav_terminology: "Calcolatore", nav_contact: "Reclutamento",
    stats_title: "Statistiche Gilda", members_label: "Membri Attivi", might_label: "Potenza Gilda", level_label: "Livello Gilda",
    profiles_title: "Leadership della Gilda", member1_name: "Capo Supremo", member1_role: "R5 LEADER",
    member2_name: "Generale di Guerra", member2_role: "R4 LEADER DI GUERRA", member3_name: "Maestro dello Scudo", member3_role: "R4 LEADER DELLA DIFESA",
    terminology_title: "Guida Tattica",
    calc_title: "Calcolatore Truppe", calc_label_total: "Capacità Marcia/Rally", calc_label_split: "Rapporto Truppe",
    calc_split_40: "40% T5 60% T4 (Standard)", calc_split_50: "50% T5 50% T4 (Bilanciato)", calc_split_60: "60% T5 40% T4 (Pesante)", calc_split_100: "100% T4 (Puro)",
    calc_label_comp: "Strategia di Formazione", comp_inf: "Fanteria (Blast)", comp_rng: "Archi (Blast)", comp_cav: "Cavalleria (Blast)",
    comp_442: "Misto 4 4 2 (Fanteria Archi)", comp_424: "Misto 4 2 4 (Fanteria Cavalleria)", comp_244: "Misto 2 4 4 (Archi Cavalleria)",
    btn_calculate: "Calcola Truppe", calc_result_title: "Panoramica Truppe", res_inf_title: "Fanteria", res_rng_title: "Archi", res_cav_title: "Cavalleria",
    btn_copy: "Copia", msg_copied: "Copiato!",
    contact_title: "Modulo di Reclutamento", label_name: "Nome in Gioco", label_iggid: "IGG ID", label_might: "Potenza Totale",
    label_role: "Ruolo in Battaglia", opt_filler: "Supporto (Filler)", opt_rally: "Rally Lead", label_message: "Messaggio", form_disclaimer: "Si prega di compilare completamente il modulo.",
    prev_btn: "Indietro", next_btn: "Procedi", submit_btn: "Invia Domanda",
    footer1: "OLD GENERATION: Coltiviamo l'eccellenza marziale dal 2016.", copy_title: "PROTEZIONE", copy_message: "Questa proprietà appartiene a OLD GENERATION.",
    ph_name: "Inserisci il tuo nome esatto", ph_iggid: "Identità Numerica", ph_might: "es. 2.5B", ph_message: "Dicci perché vuoi unirti...",
    btn_unmute: "ATTIVA AUDIO", btn_mute: "DISATTIVA AUDIO"
  }
};

function setLang(lang) {
  const t = translations[lang];
  document.documentElement.lang = lang;
  localStorage.setItem('lang', lang);
  document.title = t.title;

  const elements = {
    'nav-stats': t.nav_stats, 'nav-profiles': t.nav_profiles, 'nav-terminology': t.nav_terminology, 'nav-contact': t.nav_contact,
    'header-subtitle': t.header_subtitle, 'stats-title': t.stats_title, 'members-label': t.members_label, 'might-label': t.might_label, 'level-label': t.level_label,
    'profiles-title': t.profiles_title, 'member1-name': t.member1_name, 'member1-role': t.member1_role, 'member2-name': t.member2_name, 'member2-role': t.member2_role, 'member3-name': t.member3_name, 'member3-role': t.member3_role,
    'terminology-title': t.terminology_title, 'calc-title': t.calc_title, 'calc-label-total': t.calc_label_total, 'calc-label-split': t.calc_label_split,
    'calc-split-40': t.calc_split_40, 'calc-split-50': t.calc_split_50, 'calc-split-60': t.calc_split_60, 'calc-split-100': t.calc_split_100,
    'calc-label-comp': t.calc_label_comp, 'comp-inf': t.comp_inf, 'comp-rng': t.comp_rng, 'comp-cav': t.comp_cav, 'comp-442': t.comp_442, 'comp-424': t.comp_424, 'comp-244': t.comp_244,
    'btn-calculate': t.btn_calculate, 'calc-result-title': t.calc_result_title, 'res-inf-title': t.res_inf_title, 'res-rng-title': t.res_rng_title, 'res-cav-title': t.res_cav_title,
    'btn-copy': t.btn_copy,
    'contact-title': t.contact_title, 'label-name': t.label_name, 'label-iggid': t.label_iggid, 'label-might': t.label_might, 'label-role': t.label_role, 'opt-filler': t.opt_filler, 'opt-rally': t.opt_rally, 'label-message': t.label_message, 'form-disclaimer': t.form_disclaimer,
    'prevBtn': t.prev_btn, 'nextBtn': t.next_btn, 'submitBtn': t.submit_btn, 'footer-text1': t.footer1, 'copy-title': t.copy_title, 'copy-message': t.copy_message
  };

  for (let id in elements) {
    let el = document.getElementById(id);
    if (el) el.textContent = elements[id];
  }

  const placeholders = { 'name': t.ph_name, 'iggid': t.ph_iggid, 'might': t.ph_might, 'message': t.ph_message };
  for (let id in placeholders) {
    let el = document.getElementById(id);
    if (el) el.placeholder = placeholders[id];
  }

  const muteBtn = document.getElementById('custom-mute-btn');
  if (muteBtn) {
    if (typeof ytPlayer !== 'undefined' && ytPlayer && ytPlayer.isMuted) {
      muteBtn.textContent = ytPlayer.isMuted() ? t.btn_unmute : t.btn_mute;
    } else {
      muteBtn.textContent = t.btn_unmute;
    }
  }
}

let ytPlayer;
window.ytApiReady = false;

window.onYouTubeIframeAPIReady = function() {
  window.ytApiReady = true;
};

function loadVideoInView() {
  const isDesktop = window.innerWidth > 768;
  let pVars = {
    'autoplay': 1,
    'controls': 0,
    'mute': 1,
    'modestbranding': 1,
    'rel': 0,
    'disablekb': 1,
    'playsinline': 1,
    'loop': 1,
    'playlist': 'eD9sfQft3CQ'
  };

  if (isDesktop) {
    pVars['vq'] = 'hd1080';
  }

  ytPlayer = new YT.Player('ytplayer', {
    host: 'https://www.youtube-nocookie.com',
    videoId: 'eD9sfQft3CQ',
    playerVars: pVars,
    events: {
      'onReady': function(event) {
        if (isDesktop) event.target.setPlaybackQuality('hd1080');
        event.target.playVideo();
      },
      'onStateChange': function(event) {
        if (isDesktop && event.data == YT.PlayerState.PLAYING) {
          event.target.setPlaybackQuality('hd1080');
        }
      }
    }
  });
}

window.toggleMute = function() {
  if(ytPlayer && ytPlayer.isMuted) {
    const lang = localStorage.getItem('lang') || 'en';
    const t = translations[lang];

    if(ytPlayer.isMuted()) {
      ytPlayer.unMute();
      document.getElementById('custom-mute-btn').textContent = t.btn_mute;
    } else {
      ytPlayer.mute();
      document.getElementById('custom-mute-btn').textContent = t.btn_unmute;
    }
  }
};

window.calculateTroops = function() {
  const total = parseInt(document.getElementById('total-troops').value) || 0;
  const t5Ratio = parseInt(document.getElementById('t5-split').value) / 100;
  const t4Ratio = 1 - t5Ratio;
  const comp = document.getElementById('comp-type').value;

  let infRatio = 0, rngRatio = 0, cavRatio = 0;

  switch(comp) {
    case 'inf-blast': infRatio = 1; break;
    case 'rng-blast': rngRatio = 1; break;
    case 'cav-blast': cavRatio = 1; break;
    case '442': infRatio = 0.4; rngRatio = 0.4; cavRatio = 0.2; break;
    case '424': infRatio = 0.4; rngRatio = 0.2; cavRatio = 0.4; break;
    case '244': infRatio = 0.2; rngRatio = 0.4; cavRatio = 0.4; break;
  }

  const setVal = (id, val) => {
    let element = document.getElementById(id);
    element.textContent = Math.round(val).toLocaleString();
    element.classList.remove('pulse-active');
    void element.offsetWidth;
    element.classList.add('pulse-active');
  };

  setVal('res-t5-inf', total * t5Ratio * infRatio);
  setVal('res-t4-inf', total * t4Ratio * infRatio);
  setVal('res-t5-rng', total * t5Ratio * rngRatio);
  setVal('res-t4-rng', total * t4Ratio * rngRatio);
  setVal('res-t5-cav', total * t5Ratio * cavRatio);
  setVal('res-t4-cav', total * t4Ratio * cavRatio);

  document.getElementById('calc-results').style.display = 'block';
};

window.copyResults = function() {
  const t = translations[localStorage.getItem('lang') || 'en'];
  const total = document.getElementById('total-troops').value;
  const split = document.getElementById('t5-split').options[document.getElementById('t5-split').selectedIndex].text;
  const comp = document.getElementById('comp-type').options[document.getElementById('comp-type').selectedIndex].text;

  const t5i = document.getElementById('res-t5-inf').textContent;
  const t4i = document.getElementById('res-t4-inf').textContent;
  const t5r = document.getElementById('res-t5-rng').textContent;
  const t4r = document.getElementById('res-t4-rng').textContent;
  const t5c = document.getElementById('res-t5-cav').textContent;
  const t4c = document.getElementById('res-t4-cav').textContent;

  const textToCopy = `OLD GENERATION DEPLOYMENT MATRIX\nTotal Capacity: ${total}\nRatio Integration: ${split}\nFormation Strategy: ${comp}\n\nINFANTRY => T5: ${t5i} | T4: ${t4i}\nRANGED => T5: ${t5r} | T4: ${t4r}\nCAVALRY => T5: ${t5c} | T4: ${t4c}`;

  navigator.clipboard.writeText(textToCopy).then(() => {
    const btn = document.getElementById('btn-copy');
    const originalText = btn.textContent;
    btn.textContent = t.msg_copied;
    btn.style.background = 'var(--gold)';
    btn.style.color = '#000';
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = '#222';
      btn.style.color = '#fff';
    }, 2000);
  });
};

document.addEventListener('DOMContentLoaded', () => {
  setLang(localStorage.getItem('lang') || 'en');

  let currentStep = 1;
  const steps = document.querySelectorAll('.form-step');
  const progressBar = document.getElementById('p-bar');

  const updateUI = () => {
    steps.forEach((s, i) => s.style.display = (i + 1 === currentStep) ? 'block' : 'none');
    document.getElementById('prevBtn').style.visibility = (currentStep === 1) ? 'hidden' : 'visible';
    document.getElementById('nextBtn').style.display = (currentStep === 3) ? 'none' : 'block';
    document.getElementById('submitBtn').style.display = (currentStep === 3) ? 'block' : 'none';
    progressBar.style.width = (currentStep / 3 * 100) + '%';
  };

  updateUI();

  document.getElementById('nextBtn').addEventListener('click', () => { if (currentStep < 3) { currentStep++; updateUI(); } });
  document.getElementById('prevBtn').addEventListener('click', () => { if (currentStep > 1) { currentStep--; updateUI(); } });

  ['contextmenu', 'selectstart', 'copy'].forEach(ev => document.addEventListener(ev, e => {
    e.preventDefault();
    let ov = document.getElementById('copy-protection');
    ov.style.opacity = '1'; ov.style.pointerEvents = 'all';
    setTimeout(() => { ov.style.opacity = '0'; ov.style.pointerEvents = 'none'; }, 2000);
  }));

  const scrollBtn = document.getElementById("scrollTopBtn");
  window.onscroll = function() {
    if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
      scrollBtn.style.display = "block";
    } else {
      scrollBtn.style.display = "none";
    }
  };
  scrollBtn.addEventListener("click", () => {
    window.scrollTo({top: 0, behavior: 'smooth'});
  });

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('is-visible');
      }
    });
  }, { threshold: 0.1 });

  document.querySelectorAll('section').forEach(sec => {
    sec.classList.add('fade-in-section');
    observer.observe(sec);
  });

  const videoSection = document.getElementById('cinematic');
  if (videoSection) {
    const videoObserver = new IntersectionObserver((entries, observerInstance) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const checkApi = setInterval(() => {
            if (window.ytApiReady) {
              clearInterval(checkApi);
              loadVideoInView();
            }
          }, 100);
          observerInstance.disconnect();
        }
      });
    }, { rootMargin: '0px 0px 500px 0px' });
    videoObserver.observe(videoSection);
  }
});

if ('serviceWorker' in navigator) navigator.serviceWorker.register('/service-worker.js');
